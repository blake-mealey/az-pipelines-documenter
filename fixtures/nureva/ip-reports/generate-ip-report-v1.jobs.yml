# Audits a project's packages and generates an IP Report

parameters:
  - name: projectName
    displayName: Project Name
    type: string
  - name: projectType
    displayName: Project Type
    type: string
    values:
      - NuGet
      - NPM
  - name: packageFile
    displayName: Path to .sln or package.json
    type: string
  - name: excludeRegex
    displayName: Exclude Project Regex
    type: string
    default: ''
  - name: failOnError
    displayName: Fail the job on audit error
    type: boolean
    default: true
  - name: failOnNpmAudit
    displayName: Whether the pipeline should fail if NPM audit detects vulnerabilities
    type: boolean
    default: true
  - name: npmAuditLevel
    displayName: NPM audit level
    type: string
    default: moderate
    values:
      - low
      - moderate
      - high
      - critical
  - name: artifactName
    displayName: Artifact name of IP Report
    type: string
    default: IP_Report

jobs:
  - job: generate_ip_report
    displayName: Generate IP Report
    steps:
      - ${{ if eq(parameters.projectType, 'NPM') }}:
          - pwsh: |
              cd $(Split-Path "${{ parameters.packageFile }}" -Resolve)
              npm audit --production --registry https://registry.npmjs.org/ --audit-level=${{ parameters.npmAuditLevel }}
            displayName: NPM dependencies security scan
            continueOnError: ${{ not(parameters.failOnNpmAudit) }}

      - template: ../nuget/install-ps-modules-v1.steps.yml
        parameters:
          modules:
            - Invoke-AuditSolutionPackages
            - Publish-IntellectualPropertyReport

      - pwsh: |
          Invoke-AuditSolutionPackages -packageType "${{ parameters.projectType }}" -pathToPackageFile "${{ parameters.packageFile }}" -componentName "${{ parameters.projectName }}" -ExcludeCsprojRegex "${{ parameters.excludeRegex }}" -jiraUsername "$(NurevaComplianceJiraUsername)" -jiraAPIToken (ConvertTo-SecureString "$(NurevaComplianceJiraPassword)" -AsPlainText -Force) -autoGeneratePackageNames @("*") -autoGeneratePackageLinkPackageNames @("*") -standardErrorOnFail $True
        displayName: Audit packages
        failOnStderr: ${{ parameters.failOnError }}

      - pwsh: |
          Publish-IntellectualPropertyReport -ComponentName "${{ parameters.projectName }}" -JiraUsername "$(NurevaComplianceJiraUsername)" -JiraPersonalAccessToken "$(NurevaComplianceJiraPassword)" -OutDirectory "$(Build.ArtifactStagingDirectory)"
        displayName: Generate IP Report

      - publish: $(Build.ArtifactStagingDirectory)
        artifact: ${{ parameters.artifactName }}
        displayName: Publish IP Report Artifact
